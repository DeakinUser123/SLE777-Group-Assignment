---
title: "R Notebook"
output: html_notebook
---

load the necessary libraries
```{r}
library("seqinr") # is a package designed to process and analyse sequence data.
library("R.utils") # general utilities like zip and unzip
library("ggplot2") # plotting library 
```

1. Download the whole set of coding DNA sequences for E. coli and your organism of interest. How many coding sequences are present in these organisms? Present this in the form of a table. Describe any differences between the two organisms. 

a. Downloading E.coli data

```{r}
URL="http://ftp.ensemblgenomes.org/pub/bacteria/release-53/fasta/bacteria_0_collection/escherichia_coli_str_k_12_substr_mg1655_gca_000005845/cds/Escherichia_coli_str_k_12_substr_mg1655_gca_000005845.ASM584v2.cds.all.fa.gz"
download.file(URL,destfile="ecoli_cds.fa.gz") # Downloads the E.coli file from the URL
gunzip("ecoli_cds.fa.gz") # Unzips the E.coli gz file
list.files() # Lists all files to check if it worked
```

b. Downloading organism of interest (C. baratii) data

```{r}
URL="https://ftp.ensemblgenomes.ebi.ac.uk/pub/bacteria/release-59/fasta/bacteria_14_collection/clostridium_baratii_gca_001405755/cds/Clostridium_baratii_gca_001405755.14207_7_79.cds.all.fa.gz"
download.file(URL,destfile="clostridium_cds.fa.gz") # Downloads the C.baratii file from the URL
gunzip("clostridium_cds.fa.gz") # Unzips the C.baratii gz file
list.files() # Lists all files to check if it worked
```

c. Reading the data for both organisms 

```{r}
#Reading the uncompressed FASTA file containing coding sequences into R for both organisms
cds_ecoli <- seqinr::read.fasta("ecoli_cds.fa") 
cds_Cbaratii <- seqinr::read.fasta("clostridium_cds.fa") 
```

d. Finding the number of coding sequences

```{r}
sequences_table <- data.frame(Organism= c("Escherichia coli", "Clostridium baratii"), Num_Coding_Sequences= c(length(cds_ecoli),length(cds_Cbaratii))) # Creates the table with the total length data
sequences_table # View the table
```

2. How much coding DNA is there in total for these two organisms?

a. E. coli

```{r}
seqinr::count(unlist(cds_ecoli),1) # Counts how many nucleotides A,T,G and C in the entirety of E. coli coding sequences
sum(seqinr::count(unlist(cds_ecoli),1)) # Calculates the total nucleotide frequency in E. coli coding sequences
```

b. C. baratii

```{r}
seqinr::count(unlist(cds_Cbaratii),1)  # Counts how many nucleotides A,T,G and C in the entirety of C. baratii coding sequences
sum(seqinr::count(unlist(cds_Cbaratii),1)) # Calculates the total nucleotide frequency in C. baratii coding sequences 
```
Create a table for the results of E.coli and C.baratii 
```{r}
Coding_DNA_Table <- data.frame(Organism= c("Escherichia coli", "Clostridium baratii"), Total_Coding_DNA= c(sum(seqinr::count(unlist(cds_ecoli),1))  ,sum(seqinr::count(unlist(cds_Cbaratii),1)))) # Defining the table for total coding sequences for each organism 
Coding_DNA_Table
```


3. Calculate the length of all coding sequences in these two organisms. Make a boxplot of coding sequence length in these organisms. What is the mean and median coding sequence length of these two organisms? Describe any differences between the two organisms.

```{r}
len_ecoli <- as.numeric(summary(cds_ecoli)[,1]) # Gets the length of all sequences from the first column
len_Cbaratii <- as.numeric(summary(cds_Cbaratii)[,1]) # Gets the length of all sequences from the first column

#Getting the mean and median length for each organism 
mean(len_ecoli) # Base R Mean Function
median(len_ecoli) # Base R Median Function

mean(len_Cbaratii)
median(len_Cbaratii)

#Printing the mean and median lengths
print("The mean coding sequence length of E.coli is 938.5534 and the median is 831")
print("The mean coding sequence length of C.baratii is 920.7707 and the median is 792")

```

Boxplot of the coding sequence lengths

```{r}

# Combine lengths into a single data frame for boxplot
lengths_data <- data.frame(
  Length = c(len_ecoli, len_Cbaratii),
  Organism = factor(c(rep("E.coli", length(len_ecoli)), rep("C.baratii", length(len_Cbaratii))))
)

# Now create a boxplot
boxplot(Length ~ Organism, data = lengths_data,
        main = "Boxplot of Coding Sequence Lengths",
        xlab = "Organism",
        ylab = "Length of Coding Sequences ",
        col = c("lightblue", "lightgreen"),
        border = "black",
        boxwex = 0.5
        )

mtext("Figure 1: Boxplot of total coding sequence length for C.baratii (blue) and E. coli (green)", side = 1, line = 4, cex = 0.8)
```


4. Calculate the frequency of DNA bases in the total coding sequences for both organisms. Perform the same calculation for the total protein sequence. Create bar plots for nucleotide and amino acid frequency. Describe any differences between the two organisms.

```{r}
count(unlist(cds_ecoli),1)
count(unlist(cds_Cbaratii),1)
```


a. E. coli


```{r}
#Unlist the entire E.coli sequence, then count each nucleotide and store
ecoli_dna_composition <- count(unlist(cds_ecoli),1) 

# Bar plot of E.coli nucleotide frequency
barplot(ecoli_dna_composition,xlab="Nucleotides",ylab="Frequency", main="E.coli nucleotide composition", names.arg=toupper(names(ecoli_dna_composition)))
```

b. C. baratii

```{r}
#Unlist the entire C.baratii sequence, then count each nucleotide and store
cbaratii_dna_composition <- count(unlist(cds_Cbaratii),1) 

#Bar plot of C.baratii nucleotide frequency
barplot(cbaratii_dna_composition,
        xlab="Nucleotides",
        ylab="Frequency", 
        main="C.baratii nucleotide composition",
        names.arg=toupper(names(ecoli_dna_composition))) 
```


translation to amino acids
```{r}
 #Translate the sequences to aminoacids
prot_ecoli <- lapply(cds_ecoli,translate)
prot_cbaratii <- lapply(cds_Cbaratii,translate)
```


E. coli

```{r}
# Combine all protein sequences into a single vector
prot_ecoli_all<- unlist(prot_ecoli) 

# Define the alphabet as the unique amino acids found in the proteins
aa1 <- unique(prot_ecoli_all[prot_ecoli_all != "*"]) 

# Count occurrences of each amino acid in the combined sequence
amino_acid_counts_ecoli <- count(prot_ecoli_all, wordsize = 1, alphabet = aa1)
```


Barplot of Ecoli
```{r}
# barplot of E.coli for amino acid frequency
barplot(amino_acid_counts_ecoli,
        xlab = "Amino Acids",
        ylab = "Frequency",
        main = "Amino Acid Composition in E.coli")
```

 C. baratii
 
```{r}
# Combine all protein sequences into a single vector
prot_cbaratii_all<- unlist(prot_cbaratii)

# Define the alphabet as the unique amino acids found in the proteins
aa2 <- unique(prot_cbaratii_all[prot_cbaratii_all != "*"])

# Count occurrences of each amino acid in the combined sequence
amino_acid_counts_cbaratii <- count(prot_cbaratii_all, wordsize = 1, alphabet = aa2)
```
 
 barplot for C. baratii
 
```{r}
# barplot of C.baratii for amino acid frequency
barplot(amino_acid_counts_cbaratii,
        xlab = "Amino Acids",
        ylab = "Frequency",
        main = "Amino Acid Composition in C.baratii")
```

5.Create a codon usage table and quantify the codon usage bias among all coding sequences. Describe any differences between the two organisms with respect to their codon usage bias. Provide charts to support your observations.

Creating the codon usage tables 
```{r}
# Finds all unique codons and their RSCU and puts them into a variable 
ecoli_codon_bias <- uco(unlist(cds_ecoli[]), index="rscu", as.data.frame=TRUE)
cbaratii_codon_bias <- uco(unlist(cds_Cbaratii[]), index="rscu", as.data.frame=TRUE)

ecoli_codon_bias
cbaratii_codon_bias
```

 
 Useful charts:
 
```{r}
# Add new column called Organism and assign respective organism
ecoli_codon_bias$Organism <- "E. coli"
cbaratii_codon_bias$Organism <- "C. baratii"

# Combining the two data sets for plotting
combined_codon_bias <- rbind(ecoli_codon_bias, cbaratii_codon_bias)

# Ensuring column names are correct
colnames(combined_codon_bias) <- c("codon", "AA", "eff", "freq", "RSCU", "Organism")

# Format for the heatmap
heatmap_data <- combined_codon_bias[, c("AA", "Organism", "RSCU")]
heatmap_data$CodonGroup <- ifelse(as.numeric(factor(heatmap_data$AA)) <= 32, "First 32 Codons", "Second 32 Codons")

# Create the heatmap
ggplot(heatmap_data, aes(x = toupper(AA), y = Organism, fill = RSCU)) +
  geom_tile() + 
  scale_fill_gradient(low="white", high="red", name = "RSCU") +
  labs(title = "Codon Usage Heatmap for E. coli and C. baratii",
       x = "Codon",
       y = "Organism") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.3, hjust = 1), 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    strip.text = element_blank(),
    aspect.ratio = 0.1,
    panel.spacing = unit(1, "lines")
  ) +
  facet_wrap(~ CodonGroup, nrow = 2, scales = "free_x") #Turns it into 2 graphs

# Create a Barchart
ggplot(heatmap_data, aes(x = toupper(AA), y = RSCU, fill = Organism)) + # "toupper" upper-cases the codons 
  geom_bar(stat = "identity", position = "dodge",width = 1) + 
  scale_fill_manual(values = c("E. coli" = "blue", "C. baratii" = "red")) + 
  labs(title = "Codon Usage Bias by Codon", x = "Codon", y = "RSCU") + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.3, hjust = 1)) +
  facet_wrap(~ CodonGroup, nrow = 2, scales = "free_x") # Turns it into 2 graphs
```
 
 
6. In the organism of interest, identify 10 protein sequence k-mers of length 3-5 which are the most over- and under-represented k-mers in your organism of interest. Are these k-mers also over- and under-represented in E. coli to a similar extent? Provide plots to support your observations. Why do you think these sequences are present at different levels in the genomes of these organisms?

Creating the length 3,4 and 5 K-mers for E.coli and C.baratii
```{r}
freq_ecoli_3 <- count(prot_ecoli_all,wordsize=3,alphabet=aa1,freq=TRUE)
freq_ecoli_4 <- count(prot_ecoli_all,wordsize=4,alphabet=aa1,freq=TRUE)
freq_ecoli_5 <- count(prot_ecoli_all,wordsize=5,alphabet=aa1,freq=TRUE)

freq_cbaratii_3 <- count(prot_cbaratii_all,wordsize=3,alphabet=aa2,freq=TRUE)
freq_cbaratii_4 <- count(prot_cbaratii_all,wordsize=4,alphabet=aa2,freq=TRUE)
freq_cbaratii_5 <- count(prot_cbaratii_all,wordsize=5,alphabet=aa2,freq=TRUE)
```

Sorting the K-mers by frequency for C.baratii
```{r}
top_overrepresented_cbaratii_3 <- head(sort(freq_cbaratii_3, decreasing = TRUE), 10)

bottom_underrepresented_cbaratii_3 <- head(sort(freq_cbaratii_3), 10)

print(top_overrepresented_cbaratii_3)
print(bottom_underrepresented_cbaratii_3)

top_overrepresented_cbaratii_4 <- head(sort(freq_cbaratii_4, decreasing = TRUE), 10)

bottom_underrepresented_cbaratii_4 <- head(sort(freq_cbaratii_4), 10)

print(top_overrepresented_cbaratii_4)
print(bottom_underrepresented_cbaratii_4)

top_overrepresented_cbaratii_5 <- head(sort(freq_cbaratii_5, decreasing = TRUE), 10)

bottom_underrepresented_cbaratii_5 <- head(sort(freq_cbaratii_5), 10)

print(top_overrepresented_cbaratii_5)
print(bottom_underrepresented_cbaratii_5)

```
Sorting the K-mers by frequency for E. coli
```{r}
top_overrepresented_ecoli_3 <- head(sort(freq_ecoli_3, decreasing = TRUE), 10)

bottom_underrepresented_ecoli_3 <- head(sort(freq_ecoli_3), 10)

print(top_overrepresented_ecoli_3)
print(bottom_underrepresented_ecoli_3)

top_overrepresented_ecoli_4 <- head(sort(freq_ecoli_4, decreasing = TRUE), 10)

bottom_underrepresented_ecoli_4 <- head(sort(freq_ecoli_4), 10)

print(top_overrepresented_ecoli_4)
print(bottom_underrepresented_ecoli_4)

top_overrepresented_ecoli_5 <- head(sort(freq_ecoli_5, decreasing = TRUE), 10)

bottom_underrepresented_ecoli_5 <- head(sort(freq_ecoli_5), 10)

print(top_overrepresented_ecoli_5)
print(bottom_underrepresented_ecoli_5)
```
Creating the data for plotting 
```{r}

# Data for E. coli length 3
ecoli_kmer_3 <- data.frame(
  kmer = names(c(top_overrepresented_ecoli_3, bottom_underrepresented_ecoli_3)),
  frequency = c(top_overrepresented_ecoli_3, bottom_underrepresented_ecoli_3),
  type = c(rep("Overrepresented", 10), rep("Underrepresented", 10)),
  Organism = "E. coli",
  Length = 3
)

# Data for E. coli length 4
ecoli_kmer_4 <- data.frame(
  kmer = names(c(top_overrepresented_ecoli_4, bottom_underrepresented_ecoli_4)),
  frequency = c(top_overrepresented_ecoli_4, bottom_underrepresented_ecoli_4),
  type = c(rep("Overrepresented", 10), rep("Underrepresented", 10)),
  Organism = "E. coli",
  Length = 4
)

# Data for E. coli length 5
ecoli_kmer_5 <- data.frame(
  kmer = names(c(top_overrepresented_ecoli_5, bottom_underrepresented_ecoli_5)),
  frequency = c(top_overrepresented_ecoli_5, bottom_underrepresented_ecoli_5),
  type = c(rep("Overrepresented", 10), rep("Underrepresented", 10)),
  Organism = "E. coli",
  Length = 5
)

# Now do the same for C. baratii
# Data for C. baratii length 3
cbaratii_kmer_3 <- data.frame(
  kmer = names(c(top_overrepresented_cbaratii_3, bottom_underrepresented_cbaratii_3)),
  frequency = c(top_overrepresented_cbaratii_3, bottom_underrepresented_cbaratii_3),
  type = c(rep("Overrepresented", 10), rep("Underrepresented", 10)),
  Organism = "C. baratii",
  Length = 3
)

# Data for C. baratii length 4
cbaratii_kmer_4 <- data.frame(
  kmer = names(c(top_overrepresented_cbaratii_4, bottom_underrepresented_cbaratii_4)),
  frequency = c(top_overrepresented_cbaratii_4, bottom_underrepresented_cbaratii_4),
  type = c(rep("Overrepresented", 10), rep("Underrepresented", 10)),
  Organism = "C. baratii",
  Length = 4
)

# Data for C. baratii length 5
cbaratii_kmer_5 <- data.frame(
  kmer = names(c(top_overrepresented_cbaratii_5, bottom_underrepresented_cbaratii_5)),
  frequency = c(top_overrepresented_cbaratii_5, bottom_underrepresented_cbaratii_5),
  type = c(rep("Overrepresented", 10), rep("Underrepresented", 10)),
  Organism = "C. baratii",
  Length = 5
)

# Combine all into one data frame 
all_kmers <- rbind(ecoli_kmer_3, ecoli_kmer_4, ecoli_kmer_5,
                   cbaratii_kmer_3, cbaratii_kmer_4, cbaratii_kmer_5)

```


Adjust the frequencies with a constant, so can visually see differences for 3 k-mer and split into separate graphs
```{r}
# Add a small constant to all frequencies
ecoli_kmer_3$adjusted_frequency <- ecoli_kmer_3$frequency + 0.00001 # Because the bottom 10 look like 0 but are not

ggplot(ecoli_kmer_3, aes(x = reorder(kmer, adjusted_frequency), y = adjusted_frequency, fill = Organism)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.6) +
  labs(title = "Top 10 Overrepresented K-mers (Length 3)",
       x = "K-mer",
       y = "Frequency (Adjusted)") +
  scale_fill_manual(values = c("E. coli" = "blue", "C. baratii" = "red")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

cbaratii_kmer_3$adjusted_frequency <- cbaratii_kmer_3$frequency + 0.00001 # Because the bottom 10 look like 0 but are not

ggplot(cbaratii_kmer_3, aes(x = reorder(kmer, adjusted_frequency), y = adjusted_frequency, fill = Organism)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.6) +
  labs(title = "Top 10 Overrepresented K-mers (Length 3)",
       x = "K-mer",
       y = "Frequency (Adjusted)") +
  scale_fill_manual(values = c("E. coli" = "blue", "C. baratii" = "red")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```
Adjust the frequencies with a constant, so can visually see differences for 4 k-mer and split into separate graphs
```{r}
# Add a small constant to all frequencies
ecoli_kmer_4$adjusted_frequency <- ecoli_kmer_4$frequency + 0.0001

ggplot(ecoli_kmer_4, aes(x = reorder(kmer, adjusted_frequency), y = adjusted_frequency, fill = Organism)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.6) +
  labs(title = "Top 10 Overrepresented K-mers (Length 4)",
       x = "K-mer",
       y = "Frequency (Adjusted)") +
  scale_fill_manual(values = c("E. coli" = "blue", "C. baratii" = "red")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

cbaratii_kmer_4$adjusted_frequency <- cbaratii_kmer_4$frequency + 0.0001

ggplot(cbaratii_kmer_4, aes(x = reorder(kmer, adjusted_frequency), y = adjusted_frequency, fill = Organism)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.6) +
  labs(title = "Top 10 Overrepresented K-mers (Length 4)",
       x = "K-mer",
       y = "Frequency (Adjusted)") +
  scale_fill_manual(values = c("E. coli" = "blue", "C. baratii" = "red")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```


Adjust the frequencies with a constant, so can visually see differences for 5 k-mer and split into separate graphs
```{r}
# Add a small constant to all frequencies
ecoli_kmer_5$adjusted_frequency <- ecoli_kmer_5$frequency + 0 # We do not adjust the frequency here

ggplot(ecoli_kmer_5, aes(x = reorder(kmer, adjusted_frequency), y = adjusted_frequency, fill = Organism)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.6) +
  labs(title = "Top 10 Overrepresented K-mers (Length 5)",
       x = "K-mer",
       y = "Frequency ") +
  scale_fill_manual(values = c("E. coli" = "blue", "C. baratii" = "red")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

cbaratii_kmer_5$adjusted_frequency <- cbaratii_kmer_5$frequency + 0 # We do not adjust the frequency here

ggplot(cbaratii_kmer_5, aes(x = reorder(kmer, adjusted_frequency), y = adjusted_frequency, fill = Organism)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.6) +
  labs(title = "Top 10 Overrepresented K-mers (Length 5)",
       x = "K-mer",
       y = "Frequency ") +
  scale_fill_manual(values = c("E. coli" = "blue", "C. baratii" = "red")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

